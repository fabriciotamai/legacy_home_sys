datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  USER
}

enum UserType {
  INDIVIDUAL
  BUSINESS
}

enum ContractType {
  MONEY
  PROPERTY
  HYBRID
}

enum DepositStatus {
  WAITING_PROOF
  PENDING
  APPROVED
  REJECTED
}

enum InvestmentType {
  MONEY
  PROPERTY
}

enum InterestStatus {
  PENDING
  IN_CONTACT
  APPROVED
  REJECTED
}

enum ComplianceStatus {
  PENDING_EMAIL
  PENDING_ADDRESS
  PENDING_DOCUMENTS
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum DocumentType {
  RG
  CNH
  PASSPORT
}

enum EnterpriseStatus {
  NEW
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum ContractTemplateType {
  TYPE1
  TYPE2
  TYPE3
}

enum ContractStatus {
  PENDING
  SIGNED
  CANCELLED
}

enum ConstructionType {
  HOUSE
  LAND
  APARTMENT
  COMMERCIAL
}

enum WalletTransactionType {
  CREDIT
  DEBIT
  PIX
  TRANSFER
}

enum NotificationType {
  DEPOSIT_APPROVED
  CONTRACT_SIGNED
  INVESTMENT_CONFIRMED
  SYSTEM_ALERT
  VALUTION_CHANGE
}

enum EnterpriseChangeType {
  STATUS_CHANGED
  PHASE_CHANGED
  TASK_CHANGED
}

model User {
  id                       Int                 @id @default(autoincrement())
  email                    String              @unique
  username                 String              @unique
  password                 String
  firstName                String
  lastName                 String
  birthDate                DateTime?
  avatar                   String?
  userType                 UserType
  numberDocument           String?             @unique
  phone                    String?
  documentType             DocumentType?
  documentFront            String?
  documentBack             String?
  proofOfAddress           String?
  incomeTaxProof           String?
  mustChangePassword       Boolean             @default(true)
  tokenVersion             Int                 @default(0)
  role                     Role                @default(USER)
  isApproved               Boolean             @default(false)
  complianceStatus         ComplianceStatus    @default(PENDING_ADDRESS)
  twoFA                    String?
  isActive                 Boolean             @default(true)
  walletBalance            Float?              @default(0.0)
  totalInvested            Float?              @default(0.0)
  totalValuation           Float?              @default(0.0)
  emailVerified            Boolean             @default(false)
  emailConfirmationCode    String?
  emailConfirmationExpires DateTime?
  address                  Address?
  contracts                Contract[]
  contractInterests        ContractInterest[]
  contractSignatures       ContractSignature[]
  walletTransactions       WalletTransaction[]
  investments              Investment[]
  interestLogs             InterestLog[]
  Deposit                  Deposit[]
  createdAt                DateTime            @default(now())
  updatedAt                DateTime            @updatedAt
  Notification             Notification[]

  @@index([isApproved])
}

model Address {
  id           Int      @id @default(autoincrement())
  street       String
  number       String
  complement   String?
  neighborhood String
  city         String
  state        String
  postalCode   String
  country      String
  user         User     @relation(fields: [userId], references: [id])
  userId       Int      @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model WalletTransaction {
  id            Int                   @id @default(autoincrement())
  userId        Int
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          WalletTransactionType
  amount        Float
  balanceBefore Float
  balanceAfter  Float
  description   String
  createdAt     DateTime              @default(now())

  @@index([userId, createdAt])
}

model Investment {
  id             Int        @id @default(autoincrement())
  userId         Int
  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  enterpriseId   Int
  enterprise     Enterprise @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  investedAmount Float
  createdAt      DateTime   @default(now())
}

model EnterpriseChangeLog {
  id           Int                  @id @default(autoincrement())
  enterpriseId Int
  enterprise   Enterprise           @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  changeType   EnterpriseChangeType
  description  String
  metadata     Json?
  createdAt    DateTime             @default(now())
}

model Deposit {
  id               Int           @id @default(autoincrement())
  userId           Int
  codeDeposit      String        @unique @default(dbgenerated("substring(md5(random()::text), 1, 8)"))
  user             User          @relation(fields: [userId], references: [id])
  amount           Float
  status           DepositStatus @default(WAITING_PROOF)
  proofUrl         String?
  adminComment     String?
  approvedAt       DateTime?
  balanceUpdatedAt DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
}

model InterestLog {
  id           Int            @id @default(autoincrement())
  userId       Int
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  enterpriseId Int
  enterprise   Enterprise     @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  interestId   String
  status       InterestStatus
  reason       String?
  createdAt    DateTime       @default(now())
}

model FaqCategory {
  id   Int    @id @default(autoincrement())
  name String @unique
  faqs FAQ[]  @relation("FaqToCategory")
}

model FAQ {
  id          Int           @id @default(autoincrement())
  question    String
  answer      String
  categoryId  Int
  category    FaqCategory   @relation(fields: [categoryId], references: [id], name: "FaqToCategory")
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  FAQRevision FAQRevision[]
}

model FAQRevision {
  id        Int      @id @default(autoincrement())
  faqId     Int
  faq       FAQ      @relation(fields: [faqId], references: [id])
  answer    String
  updatedAt DateTime @default(now())

  @@index([faqId])
}

model Enterprise {
  id                Int                     @id @default(autoincrement())
  name              String                  @unique
  corporateName     String
  description       String
  status            EnterpriseStatus        @default(NEW)
  isAvailable       Boolean                 @default(false)
  investmentType    InvestmentType
  constructionType  ConstructionType
  fundingAmount     Float                   @default(0.0)
  transferAmount    Float                   @default(0.0)
  coverImageUrl     String?
  postalCode        String
  address           String
  city              String
  squareMeterValue  Float
  area              Float
  progress          Float                   @default(0.0)
  floors            Int?
  completionDate    DateTime?
  startDate         DateTime?
  currentPhaseId    Int?
  currentPhase      Phase?                  @relation(fields: [currentPhaseId], references: [id])
  currentTaskId     Int?
  currentTask       Task?                   @relation(fields: [currentTaskId], references: [id])
  taskStatuses      EnterpriseTaskStatus[]
  phaseStatuses     EnterprisePhaseStatus[]
  contracts         Contract[]
  contractInterests ContractInterest[]
  investments       Investment[]
  changeLogs        EnterpriseChangeLog[]
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  InterestLog       InterestLog[]
  images            EnterpriseImage[]

  @@index([status, createdAt])
}

model EnterpriseImage {
  id           Int        @id @default(autoincrement())
  enterpriseId Int
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  imageUrl     String
  createdAt    DateTime   @default(now())

  @@index([enterpriseId])
}

model Contract {
  id           String               @id @default(uuid())
  type         ContractType
  templateType ContractTemplateType
  documentUrl  String?
  status       ContractStatus       @default(PENDING)
  signedAt     DateTime?
  user         User                 @relation(fields: [userId], references: [id])
  userId       Int
  enterprise   Enterprise           @relation(fields: [enterpriseId], references: [id])
  enterpriseId Int
  signatures   ContractSignature[]
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
}

model ContractSignature {
  id         Int       @id @default(autoincrement())
  contract   Contract  @relation(fields: [contractId], references: [id])
  contractId String
  user       User?     @relation(fields: [userId], references: [id])
  userId     Int?
  role       Role
  signedAt   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model ContractInterest {
  interestId   String         @id @default(dbgenerated("substring(md5(random()::text), 1, 8)"))
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       Int
  enterprise   Enterprise     @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  enterpriseId Int
  status       InterestStatus @default(PENDING)
  createdAt    DateTime       @default(now())

  @@index([userId, status])
  @@index([enterpriseId, status])
}

model Phase {
  id                    Int                     @id @default(autoincrement())
  phaseName             String
  description           String
  order                 Int
  tasks                 Task[]
  enterprises           Enterprise[]
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  EnterprisePhaseStatus EnterprisePhaseStatus[]
}

model EnterprisePhaseStatus {
  enterpriseId Int
  phaseId      Int
  progress     Float      @default(0.0)
  updatedAt    DateTime   @updatedAt
  createdAt    DateTime   @default(now())
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  phase        Phase      @relation(fields: [phaseId], references: [id])

  @@id([enterpriseId, phaseId])
}

model Task {
  id           Int                    @id @default(autoincrement())
  taskName     String
  description  String
  phaseId      Int
  phase        Phase                  @relation(fields: [phaseId], references: [id])
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  taskProgress EnterpriseTaskStatus[]
  Enterprise   Enterprise[]
}

model EnterpriseTaskStatus {
  enterpriseId Int
  taskId       Int
  isCompleted  Boolean    @default(false)
  updatedAt    DateTime   @updatedAt
  createdAt    DateTime   @default(now())
  enterprise   Enterprise @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  task         Task       @relation(fields: [taskId], references: [id])

  @@id([enterpriseId, taskId])
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@index([userId, isRead])
}
